<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciador de Sensores DS18B20</title>
    
    <style>
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background: #f4f7f9; 
            color: #333; 
            padding: 20px; 
        }
        .container { 
            max-width: 800px; 
            margin: 0 auto; 
        }
        .card { 
            background: white; 
            border-radius: 12px; 
            padding: 20px; 
            margin-bottom: 20px; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.05); 
        }
        h1, h2 { 
            color: #2c3e50; 
            margin-top: 0; 
        }
        .sensor-item { 
            border-left: 4px solid #3498db; 
            background: #fcfcfc; 
            padding: 15px; 
            margin: 10px 0; 
            position: relative;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .sensor-info {
            flex: 1;
        }
        .sensor-address { 
            font-family: 'Courier New', monospace; 
            font-size: 0.9em; 
            color: #e67e22; 
            margin-top: 5px;
        }
        select, button, input { 
            width: 100%; 
            padding: 12px; 
            margin: 8px 0; 
            border-radius: 6px; 
            border: 1px solid #ddd; 
            font-size: 14px;
        }
        .btn-primary { 
            background: #3498db; 
            color: white; 
            border: none; 
            font-weight: bold; 
            cursor: pointer; 
        }
        .btn-primary:hover {
            background: #2980b9;
        }
        .btn-remove { 
            width: auto; 
            background: #e74c3c; 
            color: white; 
            border: none; 
            padding: 8px 15px; 
            cursor: pointer; 
            margin-left: 10px;
        }
        .btn-remove:hover {
            background: #c0392b;
        }
        .btn-scan {
            background: #27ae60;
            color: white;
            border: none;
            font-weight: bold;
            cursor: pointer;
        }
        .btn-scan:hover {
            background: #229954;
        }
        .temp-grid { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 15px; 
        }
        .temp-box { 
            background: #2c3e50; 
            color: #ecf0f1; 
            padding: 20px; 
            border-radius: 8px; 
            text-align: center; 
        }
        .temp-value { 
            font-size: 2em; 
            font-weight: bold; 
            display: block; 
            color: #2ecc71; 
            margin: 10px 0;
        }
        .status {
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 0.85em;
            display: inline-block;
            margin-top: 10px;
        }
        .status-online {
            background: #2ecc71;
            color: white;
        }
        .status-offline {
            background: #e74c3c;
            color: white;
        }
        .loading {
            text-align: center;
            padding: 20px;
            color: #7f8c8d;
        }
        .alert {
            background: #fff3cd;
            border: 1px solid #ffc107;
            color: #856404;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 15px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="card">
            <h1>üç∫ Gerenciador de Sensores</h1>
            <p>Configure os sensores DS18B20 para controle da fermenta√ß√£o</p>
            <div id="connection-status"></div>
        </div>
        
        <div class="card">
            <h2>üîç Sensores Detectados pelo ESP8266</h2>
            <p style="color: #7f8c8d; font-size: 0.9em;">
                Clique em "Escanear Sensores" para que o ESP8266 busque todos os sensores DS18B20 conectados
            </p>
            <button id="scan-btn" class="btn-scan" onclick="requestSensorScan()">
                üîÑ Escanear Sensores no ESP8266
            </button>
            <div id="detected-sensors" class="loading">Aguardando scan...</div>
        </div>
        
        <div class="card">
            <h2>üîó Atribuir Sensor</h2>
            <div class="alert">
                <strong>‚ö†Ô∏è Aten√ß√£o:</strong> Selecione o endere√ßo f√≠sico detectado e a fun√ß√£o correspondente
            </div>
            
            <label><strong>Endere√ßo F√≠sico (Detectado pelo ESP):</strong></label>
            <select id="sensor-select">
                <option value="">Selecione um sensor...</option>
            </select>
            
            <label><strong>Fun√ß√£o no Processo:</strong></label>
            <select id="device-select">
                <option value="">Escolha a fun√ß√£o...</option>
                <option value="sensor_fermentador">üç∫ Sensor do Fermentador</option>
                <option value="sensor_geladeira">‚ùÑÔ∏è Sensor da Geladeira</option>
            </select>
            
            <button id="assign-btn" class="btn-primary" onclick="assignSensor()">
                üíæ Salvar Configura√ß√£o
            </button>
        </div>
        
        <div class="card">
            <h2>üìã Sensores Configurados</h2>
            <div id="assigned-sensors" class="loading">Carregando...</div>
        </div>

        <div class="card">
            <h2>üå°Ô∏è Temperaturas em Tempo Real</h2>
            <div class="temp-grid">
                <div class="temp-box">
                    <div>üç∫ Fermentador</div>
                    <span id="temp-fermenter" class="temp-value">--.-</span>
                    <div>¬∞C</div>
                </div>
                <div class="temp-box">
                    <div>‚ùÑÔ∏è Geladeira</div>
                    <span id="temp-fridge" class="temp-value">--.-</span>
                    <div>¬∞C</div>
                </div>
            </div>
            <div style="text-align: center; margin-top: 15px; color: #95a5a6; font-size: 0.9em;">
                √öltima atualiza√ß√£o: <span id="last-update">--:--</span>
            </div>
        </div>

        <div class="card">
            <button onclick="location.href='index.html'" class="btn-primary">
                ‚¨ÖÔ∏è Voltar para Monitor
            </button>
        </div>
    </div>

    <script>
        const API_BASE = '/api.php?path=';
        
        let detectedSensors = [];
        let assignedSensors = {};
        
        // ==================== INICIALIZA√á√ÉO ====================
        async function init() {
            await checkConnection();
            await loadAssignedSensors();
            await loadDetectedSensors();
            startTemperatureMonitoring();
        }

        // ==================== VERIFICAR CONEX√ÉO ====================
        async function checkConnection() {
            try {
                const response = await fetch(API_BASE + 'sensors&action=ping');
                const data = await response.json();
                
                const statusDiv = document.getElementById('connection-status');
                if (data.success) {
                    statusDiv.innerHTML = '<span class="status status-online">‚úì Conectado ao servidor</span>';
                } else {
                    statusDiv.innerHTML = '<span class="status status-offline">‚úó Erro de conex√£o</span>';
                }
            } catch (error) {
                document.getElementById('connection-status').innerHTML = 
                    '<span class="status status-offline">‚úó Servidor offline</span>';
            }
        }

        // ==================== SCAN DE SENSORES ====================
        async function requestSensorScan() {
            const btn = document.getElementById('scan-btn');
            btn.disabled = true;
            btn.textContent = '‚è≥ Escaneando...';
            
            document.getElementById('detected-sensors').innerHTML = 
                '<div class="loading">Aguardando resposta do ESP8266...</div>';
            
            try {
                // Envia comando para ESP8266 escanear
                const response = await fetch(API_BASE + 'sensors&action=request_scan', {
                    method: 'POST'
                });
                
                if (response.ok) {
                    alert('‚úÖ Comando de scan enviado ao ESP8266! Aguarde alguns segundos e os sensores aparecer√£o automaticamente.');
                    
                    // Aguarda 3 segundos e recarrega
                    setTimeout(() => {
                        loadDetectedSensors();
                    }, 3000);
                } else {
                    alert('‚ùå Erro ao enviar comando de scan');
                }
            } catch (error) {
                console.error('Erro:', error);
                alert('‚ùå Erro de comunica√ß√£o com o servidor');
            } finally {
                btn.disabled = false;
                btn.textContent = 'üîÑ Escanear Sensores no ESP8266';
            }
        }

        // ==================== CARREGAR SENSORES DETECTADOS ====================
        async function loadDetectedSensors() {
            try {
                const response = await fetch(API_BASE + 'sensors&action=get_detected');
                const data = await response.json();
                
                if (data.success && data.sensors) {
                    detectedSensors = data.sensors;
                    updateDetectedList();
                    updateSensorSelect();
                } else {
                    document.getElementById('detected-sensors').innerHTML = 
                        '<p style="color: #95a5a6;">Nenhum sensor detectado ainda. Clique em "Escanear Sensores".</p>';
                }
            } catch (error) {
                console.error('Erro ao carregar sensores:', error);
            }
        }

        // ==================== ATUALIZAR LISTA DE DETECTADOS ====================
        function updateDetectedList() {
            const container = document.getElementById('detected-sensors');
            
            if (detectedSensors.length === 0) {
                container.innerHTML = '<p style="color: #95a5a6;">Nenhum sensor detectado</p>';
                return;
            }
            
            let html = `<p style="color: #27ae60; font-weight: bold;">‚úì ${detectedSensors.length} sensor(es) encontrado(s)</p>`;
            
            detectedSensors.forEach((addr, index) => {
                const isAssigned = Object.values(assignedSensors).includes(addr);
                const badge = isAssigned ? '<span style="color: #2ecc71;">‚úì Configurado</span>' : '';
                
                html += `
                    <div class="sensor-item">
                        <div class="sensor-info">
                            <strong>Sensor ${index + 1}</strong> ${badge}
                            <div class="sensor-address">${addr}</div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        // ==================== ATUALIZAR SELECT ====================
        function updateSensorSelect() {
            const select = document.getElementById('sensor-select');
            let html = '<option value="">Selecione um sensor...</option>';
            
            detectedSensors.forEach((addr, index) => {
                const isAssigned = Object.values(assignedSensors).includes(addr);
                const label = isAssigned ? `Sensor ${index + 1} (j√° configurado)` : `Sensor ${index + 1}`;
                html += `<option value="${addr}" ${isAssigned ? 'style="color: #95a5a6;"' : ''}>${label}: ${addr}</option>`;
            });
            
            select.innerHTML = html;
        }

        // ==================== CARREGAR SENSORES CONFIGURADOS ====================
        async function loadAssignedSensors() {
            try {
                const response = await fetch(API_BASE + 'sensors&action=get_assigned');
                const data = await response.json();
                
                if (data.success && data.sensors) {
                    assignedSensors = data.sensors;
                    updateAssignedList();
                }
            } catch (error) {
                console.error('Erro ao carregar sensores configurados:', error);
            }
        }

        // ==================== ATUALIZAR LISTA DE CONFIGURADOS ====================
        function updateAssignedList() {
            const container = document.getElementById('assigned-sensors');
            
            if (Object.keys(assignedSensors).length === 0) {
                container.innerHTML = '<p style="color: #95a5a6;">Nenhum sensor configurado ainda</p>';
                return;
            }
            
            let html = '';
            Object.entries(assignedSensors).forEach(([key, address]) => {
                const icon = key === 'sensor_fermentador' ? 'üç∫' : '‚ùÑÔ∏è';
                const name = key === 'sensor_fermentador' ? 'Fermentador' : 'Geladeira';
                
                html += `
                    <div class="sensor-item">
                        <div class="sensor-info">
                            <strong>${icon} ${name}</strong>
                            <div class="sensor-address">${address}</div>
                        </div>
                        <button class="btn-remove" onclick="removeSensor('${key}')">
                            üóëÔ∏è Remover
                        </button>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        // ==================== ATRIBUIR SENSOR ====================
        async function assignSensor() {
            const address = document.getElementById('sensor-select').value;
            const role = document.getElementById('device-select').value;
            
            if (!address || !role) {
                alert('‚ö†Ô∏è Selecione o endere√ßo e a fun√ß√£o do sensor!');
                return;
            }
            
            try {
                const response = await fetch(API_BASE + 'sensors&action=assign', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ address, role })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert('‚úÖ Sensor configurado com sucesso! O ESP8266 foi notificado.');
                    await loadAssignedSensors();
                    updateSensorSelect();
                } else {
                    alert('‚ùå Erro ao configurar sensor: ' + (data.error || 'Erro desconhecido'));
                }
            } catch (error) {
                console.error('Erro:', error);
                alert('‚ùå Erro de comunica√ß√£o com o servidor');
            }
        }

        // ==================== REMOVER SENSOR ====================
        async function removeSensor(role) {
            if (!confirm(`Deseja remover a configura√ß√£o do sensor ${role === 'sensor_fermentador' ? 'Fermentador' : 'Geladeira'}?`)) {
                return;
            }
            
            try {
                const response = await fetch(API_BASE + 'sensors&action=remove', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ role })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert('‚úÖ Sensor removido com sucesso!');
                    await loadAssignedSensors();
                    updateSensorSelect();
                } else {
                    alert('‚ùå Erro ao remover sensor');
                }
            } catch (error) {
                console.error('Erro:', error);
                alert('‚ùå Erro de comunica√ß√£o');
            }
        }

        // ==================== MONITORAR TEMPERATURAS ====================
        function startTemperatureMonitoring() {
            updateTemperatures();
            setInterval(updateTemperatures, 5000); // Atualiza a cada 5 segundos
        }

        async function updateTemperatures() {
            try {
                const response = await fetch(API_BASE + 'sensors&action=get_temperatures');
                const data = await response.json();
                
                if (data.success && data.temperatures) {
                    document.getElementById('temp-fermenter').textContent = 
                        data.temperatures.fermenter ? data.temperatures.fermenter.toFixed(1) : '--.-';
                    
                    document.getElementById('temp-fridge').textContent = 
                        data.temperatures.fridge ? data.temperatures.fridge.toFixed(1) : '--.-';
                    
                    const now = new Date();
                    document.getElementById('last-update').textContent = 
                        now.toLocaleTimeString('pt-BR');
                }
            } catch (error) {
                // Silenciosamente falha (n√£o incomoda o usu√°rio)
            }
        }

        // ==================== INICIAR AO CARREGAR ====================
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>